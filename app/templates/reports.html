{% extends 'dashboard_base.html' %}

{% block title %}Reports & Analytics{% endblock %}

{% block page_title %}Reports & Analytics{% endblock %}

{% block content %}

<!-- ===================== Overview Stats ===================== -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h3 style="margin: 0; font-size: 2.5rem; font-weight: bold;">{{ total_deployments|default:"0" }}</h3>
                <p style="margin: 5px 0 0; opacity: 0.9; font-size: 1rem;">Total Deployments</p>
            </div>
            <div style="font-size: 3rem; opacity: 0.3;">üìä</div>
        </div>
    </div>

    <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h3 style="margin: 0; font-size: 2.5rem; font-weight: bold;">{{ active_sites|default:"0" }}</h3>
                <p style="margin: 5px 0 0; opacity: 0.9; font-size: 1rem;">Active Sites</p>
            </div>
            <div style="font-size: 3rem; opacity: 0.3;">‚úÖ</div>
        </div>
    </div>

    <div style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h3 style="margin: 0; font-size: 2.5rem; font-weight: bold;">{{ storage_used|default:"0" }}MB</h3>
                <p style="margin: 5px 0 0; opacity: 0.9; font-size: 1rem;">Storage Used</p>
            </div>
            <div style="font-size: 3rem; opacity: 0.3;">üíæ</div>
        </div>
    </div>

    <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h3 style="margin: 0; font-size: 2.5rem; font-weight: bold;">{{ success_rate|default:"0" }}%</h3>
                <p style="margin: 5px 0 0; opacity: 0.9; font-size: 1rem;">Success Rate</p>
            </div>
            <div style="font-size: 3rem; opacity: 0.3;">üéØ</div>
        </div>
    </div>
</div>

<!-- ===================== Charts Row ===================== -->
<div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 30px;">
    <!-- Deployment Timeline -->
    <div style="background: #fff; padding: 25px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
        <h3 style="margin-top: 0; margin-bottom: 20px; color: #333;">Deployment Timeline</h3>
        <div style="position: relative; height: 150px;">
            <canvas id="deploymentChart"></canvas>
        </div>
    </div>

    <!-- Project Types -->
    <div style="background: #fff; padding: 25px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
        <h3 style="margin-top: 0; margin-bottom: 20px; color: #333;">Project Types</h3>
        <div style="text-align: center; position: relative; height: 150px;">
            <canvas id="projectTypeChart"></canvas>
        </div>
        <div style="margin-top: 15px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                <span style="display: flex; align-items: center;">
                    <div style="width: 12px; height: 12px; background: #007bff; border-radius: 50%; margin-right: 8px;"></div>
                    Django Apps
                </span>
                <span style="font-weight: 600;">{{ django_count|default:"0" }}</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <span style="display: flex; align-items: center;">
                    <div style="width: 12px; height: 12px; background: #28a745; border-radius: 50%; margin-right: 8px;"></div>
                    Static Sites
                </span>
                <span style="font-weight: 600;">{{ static_count|default:"0" }}</span>
            </div>
        </div>
    </div>
</div>

<!-- ===================== Recent Activity ===================== -->
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
    <!-- Recent Deployments -->
    <div style="background: #fff; padding: 25px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
        <h3 style="margin-top: 0; margin-bottom: 20px; color: #333;">Recent Deployments</h3>
        {% if recent_deployments %}
            <div style="max-height: 300px; overflow-y: auto;">
                {% for deployment in recent_deployments %}
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #f1f3f4;">
                        <div>
                            <div style="font-weight: 600; color: #333;">
                                {% if deployment.project_name %}
                                    {{ deployment.project_name }}
                                    <span style="background: #007bff; color: white; padding: 2px 6px; border-radius: 12px; font-size: 10px; margin-left: 5px;">DJANGO</span>
                                {% else %}
                                    {{ deployment.title }}
                                    <span style="background: #28a745; color: white; padding: 2px 6px; border-radius: 12px; font-size: 10px; margin-left: 5px;">STATIC</span>
                                {% endif %}
                            </div>
                            <div style="font-size: 0.875rem; color: #6c757d;">
                                {{ deployment.created_at|date:"M d, Y H:i" }}
                            </div>
                        </div>
                        <div>
                            {% if deployment.is_active %}
                                <span style="color: #28a745;">‚óè Active</span>
                            {% else %}
                                <span style="color: #dc3545;">‚óè Inactive</span>
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div style="text-align: center; color: #6c757d; padding: 40px 0;">
                <div style="font-size: 3rem; margin-bottom: 15px;">üì≠</div>
                <p>No deployments yet</p>
                <a href="{% url 'deploy_static' %}" style="color: #007bff;">Deploy your first site</a>
            </div>
        {% endif %}
    </div>

    <!-- System Status -->
    <div style="background: #fff; padding: 25px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
        <h3 style="margin-top: 0; margin-bottom: 20px; color: #333;">System Status</h3>
        <div style="margin-bottom: 15px;">
            <div style="display: flex; justify-content: space-between;"><span>Deployment Service</span><span style="color:#28a745;">‚óè</span></div>
            <div style="background:#f8f9fa;height:6px;border-radius:3px;overflow:hidden;"><div style="background:#28a745;width:98%;height:100%;"></div></div>
            <div style="font-size:0.75rem;color:#6c757d;">98% uptime</div>
        </div>
        <div style="margin-bottom: 15px;">
            <div style="display: flex; justify-content: space-between;"><span>Static Hosting</span><span style="color:#28a745;">‚óè</span></div>
            <div style="background:#f8f9fa;height:6px;border-radius:3px;overflow:hidden;"><div style="background:#28a745;width:100%;height:100%;"></div></div>
            <div style="font-size:0.75rem;color:#6c757d;">100% uptime</div>
        </div>
        <div style="margin-bottom: 15px;">
            <div style="display: flex; justify-content: space-between;"><span>Django Hosting</span><span style="color:#ffc107;">‚óè</span></div>
            <div style="background:#f8f9fa;height:6px;border-radius:3px;overflow:hidden;"><div style="background:#ffc107;width:85%;height:100%;"></div></div>
            <div style="font-size:0.75rem;color:#6c757d;">85% uptime</div>
        </div>
        <div>
            <div style="display: flex; justify-content: space-between;"><span>Database Service</span><span style="color:#28a745;">‚óè</span></div>
            <div style="background:#f8f9fa;height:6px;border-radius:3px;overflow:hidden;"><div style="background:#28a745;width:99%;height:100%;"></div></div>
            <div style="font-size:0.75rem;color:#6c757d;">99% uptime</div>
        </div>
    </div>
</div>

<!-- ===================== All Projects Table ===================== -->
<div style="background: #fff; padding: 25px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
        <h3 style="margin:0;color:#333;">All Projects</h3>
        <div>
            <select id="projectFilter" style="padding:6px 12px;border:1px solid #ddd;border-radius:4px;margin-right:10px;">
                <option value="all">All Projects</option>
                <option value="django">Django Apps</option>
                <option value="static">Static Sites</option>
                <option value="active">Active Only</option>
            </select>
            <button onclick="exportData()" style="background:#28a745;color:white;padding:6px 12px;border:none;border-radius:4px;cursor:pointer;">
                Export CSV
            </button>
        </div>
    </div>

    <div style="overflow-x:auto;">
        <table style="width:100%;border-collapse:collapse;font-size:0.9rem;">
            <thead>
                <tr style="background:#f8f9fa;border-bottom:2px solid #e9ecef;">
                    <th style="padding:12px;text-align:left;">Project</th>
                    <th style="padding:12px;text-align:left;">Type</th>
                    <th style="padding:12px;text-align:left;">Status</th>
                    <th style="padding:12px;text-align:left;">Domain</th>
                    <th style="padding:12px;text-align:left;">Created</th>
                    <th style="padding:12px;text-align:left;">Size</th>
                </tr>
            </thead>
            <tbody id="projectsTableBody">
                {% for project in all_projects %}
                <tr style="border-bottom:1px solid #e9ecef;"
                    data-type="{% if project.project_name %}django{% else %}static{% endif %}"
                    data-status="{% if project.is_active %}active{% else %}inactive{% endif %}">
                    <td style="padding:12px;font-weight:600;color:#333;">
                        {% if project.project_name %}{{ project.project_name }}{% else %}{{ project.title }}{% endif %}
                    </td>
                    <td style="padding:12px;">
                        {% if project.project_name %}
                            <span style="background:#007bff;color:white;padding:4px 8px;border-radius:12px;font-size:0.75rem;">Django</span>
                        {% else %}
                            <span style="background:#28a745;color:white;padding:4px 8px;border-radius:12px;font-size:0.75rem;">Static</span>
                        {% endif %}
                    </td>
                    <td style="padding:12px;">
                        {% if project.is_active %}
                            <span style="color:#28a745;">‚óè Active</span>
                        {% else %}
                            <span style="color:#dc3545;">‚óè Inactive</span>
                        {% endif %}
                    </td>
                    <td style="padding:12px;">
                        {% if project.domain_name %}
                            <a href="{{ project.domain_name }}" target="_blank" style="color:#007bff;">
                                {{ project.domain_name|slice:":30" }}{% if project.domain_name|length > 30 %}...{% endif %}
                            </a>
                        {% else %}
                            <span style="color:#6c757d;">-</span>
                        {% endif %}
                    </td>
                    <td style="padding:12px;color:#6c757d;">
                        {{ project.created_at|date:"M d, Y" }}
                    </td>
                    <td style="padding:12px;color:#6c757d;">
                        {% if project.project_file %}
                            {{ project.project_file.size|filesizeformat }}
                        {% elif project.uploaded_file %}
                            {{ project.uploaded_file.size|filesizeformat }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6" style="padding:40px;text-align:center;color:#6c757d;">
                        No projects found. <a href="{% url 'deploy_static' %}" style="color:#007bff;">Deploy your first project</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- ===================== Scripts ===================== -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize charts only if canvas elements exist
    const deploymentCanvas = document.getElementById('deploymentChart');
    const projectTypeCanvas = document.getElementById('projectTypeChart');
    
    if (deploymentCanvas) {
        const ctx1 = deploymentCanvas.getContext('2d');
        
        // Get data from Django template variables, with fallbacks
        let deploymentDates, deploymentCounts;
        try {
            deploymentDates = {{ deployment_dates|safe|default:"[]" }};
            deploymentCounts = {{ deployment_counts|safe|default:"[]" }};
        } catch (e) {
            console.warn('Chart data not available:', e);
            deploymentDates = [];
            deploymentCounts = [];
        }
        
        new Chart(ctx1, {
            type: 'line',
            data: {
                labels: deploymentDates,
                datasets: [{
                    label: 'Deployments',
                    data: deploymentCounts,
                    borderColor: '#007bff',
                    backgroundColor: 'rgba(0,123,255,0.1)',
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { display: false } 
                },
                scales: { 
                    y: { 
                        beginAtZero: true, 
                        ticks: { stepSize: 1 } 
                    } 
                }
            }
        });
    }

    if (projectTypeCanvas) {
        const ctx2 = projectTypeCanvas.getContext('2d');
        
        // Get counts with fallbacks
        let djangoCount, staticCount;
        try {
            djangoCount = parseInt('{{ django_count|default:"0" }}') || 0;
            staticCount = parseInt('{{ static_count|default:"0" }}') || 0;
        } catch (e) {
            console.warn('Project count data not available:', e);
            djangoCount = 0;
            staticCount = 0;
        }
        
        new Chart(ctx2, {
            type: 'doughnut',
            data: {
                labels: ['Django Apps', 'Static Sites'],
                datasets: [{
                    data: [djangoCount, staticCount],
                    backgroundColor: ['#007bff', '#28a745'],
                    borderWidth: 0
                }]
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false, 
                plugins: { 
                    legend: { display: false } 
                } 
            }
        });
    }

    // Project filter functionality
    const projectFilter = document.getElementById('projectFilter');
    if (projectFilter) {
        const rows = document.querySelectorAll('#projectsTableBody tr[data-type]');
        
        projectFilter.addEventListener('change', function() {
            const filter = this.value;
            
            rows.forEach(function(row) {
                const type = row.getAttribute('data-type');
                const status = row.getAttribute('data-status');
                let shouldShow = false;
                
                switch(filter) {
                    case 'all':
                        shouldShow = true;
                        break;
                    case 'active':
                        shouldShow = status === 'active';
                        break;
                    case 'django':
                        shouldShow = type === 'django';
                        break;
                    case 'static':
                        shouldShow = type === 'static';
                        break;
                }
                
                row.style.display = shouldShow ? '' : 'none';
            });
        });
    }
});

function exportData() {
    try {
        const table = document.querySelector('table');
        if (!table) {
            alert('No table found to export');
            return;
        }
        
        const rows = table.querySelectorAll('tr');
        let csv = [];
        
        rows.forEach(function(row) {
            if (row.style.display !== 'none') {
                const cells = row.querySelectorAll('th, td');
                const rowData = Array.from(cells).map(function(cell) {
                    // Clean up cell content and escape commas
                    const text = cell.textContent.trim().replace(/"/g, '""');
                    return text.includes(',') ? '"' + text + '"' : text;
                });
                csv.push(rowData.join(','));
            }
        });
        
        if (csv.length === 0) {
            alert('No data to export');
            return;
        }
        
        const csvContent = csv.join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = window.URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = 'projects_report_' + new Date().toISOString().split('T')[0] + '.csv';
        a.style.display = 'none';
        
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
    } catch (error) {
        console.error('Export failed:', error);
        alert('Export failed. Please try again.');
    }
}
</script>

<style>
table th { 
    white-space: nowrap; 
}

table tr:hover { 
    background-color: #f8f9fa; 
}

/* Responsive design */
@media (max-width: 768px) {
    div[style*="grid-template-columns: 2fr 1fr"],
    div[style*="grid-template-columns: 1fr 1fr"] { 
        grid-template-columns: 1fr !important; 
    }
    
    table { 
        font-size: 0.8rem; 
    }
    
    th, td { 
        padding: 8px !important; 
    }
    
    /* Make charts smaller on mobile */
    div[style*="height: 150px"] {
        height: 120px !important;
    }
}

/* Chart container improvements */
canvas {
    max-width: 100%;
}

/* Ensure proper spacing */
.chart-container {
    position: relative;
    height: 150px;
    width: 100%;
}
</style>

{% endblock %}